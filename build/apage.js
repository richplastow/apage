// Generated by CoffeeScript 1.9.1

/*! Apage 0.0.7 //// MIT Licence //// http://apage.richplastow.com/ */

(function() {
  var Article, Main, dirname, filename, filterLine, marked, ordername, page, script, style, tidypath, ª, ªA, ªB, ªE, ªF, ªI, ªN, ªO, ªR, ªS, ªU, ªV, ªX, ªclone, ªhas, ªpopulate, ªtype;

  ªI = 'Apage';

  ªV = '0.0.7';

  ªA = 'array';

  ªB = 'boolean';

  ªE = 'error';

  ªF = 'function';

  ªN = 'number';

  ªO = 'object';

  ªR = 'regexp';

  ªS = 'string';

  ªU = 'undefined';

  ªX = 'null';

  ª = console.log.bind(console);

  ªhas = function(h, n, t, f) {
    if (t == null) {
      t = true;
    }
    if (f == null) {
      f = false;
    }
    if (-1 !== h.indexOf(n)) {
      return t;
    } else {
      return f;
    }
  };

  ªtype = function(x) {
    return {}.toString.call(x).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
  };

  ªpopulate = function(candidate, subject, rules, updating) {
    var errors, j, k, key, len, len1, rule, test, type, use, value;
    if (ªO !== ªtype(candidate)) {
      return ["`candidate` is type '" + (ªtype(candidate)) + "' not 'object'"];
    }
    errors = [];
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (updating || void 0 !== use) {
          continue;
        } else {
          errors.push("Missing field '" + key + "' is mandatory");
        }
      } else if (type !== ªtype(value)) {
        errors.push("Field '" + key + "' is type '" + (ªtype(value)) + "' not '" + type + "'");
      } else if (!test.test(value)) {
        errors.push("Field '" + key + "' fails " + ('' + test));
      }
    }
    if (errors.length) {
      return errors;
    }
    for (k = 0, len1 = rules.length; k < len1; k++) {
      rule = rules[k];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (void 0 === subject[key]) {
          subject[key] = use;
        }
      } else {
        subject[key] = value;
      }
    }
  };

  ªclone = function(subject, rules) {
    var j, key, len, out, rule;
    out = {};
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0];
      out[key] = subject[key];
    }
    return out;
  };

  Article = (function() {
    Article.prototype.I = 'Article';

    Article.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Article.prototype._rules = {
      config: [['path', void 0, 'string', /^[-.\/a-zA-Z0-9]{1,64}$/], ['raw', '@todo\n=====\n', 'string', /^[^\x00-\x08\x0E-\x1F]{0,10000}$/]]
    };

    function Article(config) {
      var errors, i, j, key, len, line, ref, ref1, value;
      if (config == null) {
        config = {};
      }
      this._config = {};
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
      this.path = this._config.path.replace(/^[.\/]+/g, '');
      this.meta = [];
      if ('---\n' === this._config.raw.substr(0, 4)) {
        this._config.raw = this._config.raw.split('---\n');
        ref = this._config.raw[1].split('\n');
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          line = ref[i];
          ref1 = line.split(': '), key = ref1[0], value = ref1[1];
          if (!key || !value) {
            continue;
          }
          if ('title' === key) {
            this.title = value;
          } else {
            this.meta[i] = {
              key: key,
              value: value
            };
          }
        }
        this._config.raw = (this._config.raw.slice(2)).join('---\n');
      }
      this._config.raw = this._config.raw.replace(/^\s+|\s+$/g, '');
      this.title = this.title || (this._config.raw.split('\n'))[0];
      this.html = (marked(this._config.raw)).replace(/\\/g, '\\\\').split('\n');
    }

    Article.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    return Article;

  })();

  Main = (function() {
    Main.prototype.I = ªI;

    Main.prototype.V = ªV;

    Main.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Main.prototype._rules = {
      config: [['title', 'Untitled', 'string', /^[^\x00-\x1F]{1,24}$/], ['url', false, 'string', /^[-:.\/a-z0-9]{1,64}$/]]
    };

    function Main(config) {
      var errors;
      if (config == null) {
        config = {};
      }
      this._config = {};
      this._articles = [];
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
    }

    Main.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    Main.prototype.append = function(article) {
      if (!article) {
        return this;
      }
      this._articles.push(new Article(article));
      return this;
    };

    Main.prototype.render = function() {
      return "" + (page(this._config, this._articles));
    };

    return Main;

  })();

  if (ªF === typeof define && define.amd) {
    define(function() {
      return Main;
    });
  } else if (ªO === typeof module && module && module.exports) {
    module.exports = Main;
  } else {
    this[ªI] = Main;
  }

  if (ªF === typeof define && define.amd) {

  } else if (ªO === typeof module && module && module.exports) {
    marked = require('marked');
  } else {
    marked = window.marked;
  }

  marked.setOptions({});

  page = function(config, articles) {
    return "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title>" + config.title + "</title>\n  <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\">\n  <meta name=\"generator\" content=\"" + ªI + " " + ªV + " http://apage.richplastow.com/\">\n  <style>\n    " + (style(config)) + "\n  </style>\n  <script>\n" + (script(config, articles)) + "\n  </script>\n</head>\n<body>\n\n  <nav class=\"nav\" tabindex=\"-1\" onclick=\"this.focus()\">\n    <div class=\"container\">\n    </div>\n  </nav>\n  <div class=\"btn btn-sm btn-close\">×</div>\n\n  <div class=\"container\">\n    <div class=\"col content\"></div>\n  </div>\n\n</body>\n</html>";
  };

  style = function(config) {
    return "/* normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */\n\n    /* Document */\n    html { font-family:sans-serif; -ms-text-size-adjust:100%; -webkit-text-size-adjust:100% }\n    body { margin:0 }\n\n    /* HTML5 */\n    article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,\n    section,summary { display: block }\n    audio,canvas,progress,video { display:inline-block; vertical-align:baseline }\n    audio:not([controls]) { display:none; height:0 }\n    [hidden],template { display:none }\n\n    /* Links */\n    a { background-color:transparent }\n    a:active,a:hover { outline:0 }\n\n    /* Text */\n    abbr[title] { border-bottom: 1px dotted }\n    b, strong { font-weight: bold }\n    dfn { font-style: italic }\n    h1 { font-size: 2em; margin: 0.67em 0 }\n    mark { background: #ff0; color: #000 }\n    small { font-size: 80% }\n    sub,sup { font-size:75%; line-height:0; position:relative; vertical-align:baseline }\n    sup { top: -0.5em }\n    sub { bottom: -0.25em }\n\n    /* Embedded */\n    img { border: 0 }\n    svg:not(:root) { overflow: hidden }\n\n    /* Grouping */\n    figure { margin: 1em 40px }\n    hr { box-sizing: content-box; height: 0 }\n    pre { overflow: auto }\n    code,kbd,pre,samp { font-family:monospace,monospace; font-size:1em }\n\n    /* Forms */\n    button,input,optgroup,select,textarea { color:inherit; font:inherit; margin:0 }\n    button { overflow:visible }\n    button,select { text-transform:none }\n    button,html input[type=\"button\"],input[type=\"reset\"],\n    input[type=\"submit\"] { -webkit-appearance:button; cursor:pointer }\n    button[disabled],html input[disabled] { cursor:default }\n    button::-moz-focus-inner,input::-moz-focus-inner{ border:0; padding:0 }\n    input { line-height:normal }\n    input[type=\"checkbox\"],input[type=\"radio\"] { box-sizing:border-box; padding:0 }\n    input[type=\"number\"]::-webkit-inner-spin-button,\n    input[type=\"number\"]::-webkit-outer-spin-button { height:auto }\n    input[type=\"search\"] { -webkit-appearance:textfield; box-sizing:content-box }\n    input[type=\"search\"]::-webkit-search-cancel-button,\n    input[type=\"search\"]::-webkit-search-decoration { -webkit-appearance:none }\n    fieldset { border:1px solid #c0c0c0; margin:0 2px; padding:0.35em 0.625em 0.75em }\n    legend { border:0; padding:0 }\n    textarea { overflow:auto }\n    optgroup { font-weight:bold }\n\n    /* Tables */\n    table { border-collapse:collapse; border-spacing:0 }\n    td,th { padding:0 }\n\n\n    /* https://raw.githubusercontent.com/owenversteeg/min/gh-pages/compiled/general.css */\n    body,\n    textarea,\n    input,\n    select {\n      background: 0;\n      border-radius: 0;\n      font: 16px sans-serif;\n      margin: 0;\n    }\n    .addon,\n    .btn-sm,\n    .nav,\n    textarea,\n    input,\n    select {\n      outline: 0;\n      font-size: 14px;\n    }\n    .smooth {\n      transition: all .2s;\n    }\n    .btn,\n    .nav a {\n      text-decoration: none;\n    }\n    .container {\n      margin: 0 20px;\n      width: auto;\n    }\n    @media (min-width: 1310px) {\n      .container {\n        margin: auto;\n        width: 1270px;\n      }\n    }\n    .btn,\n    h2 {\n      font-size: 2em;\n    }\n\n\n    /* https://raw.githubusercontent.com/owenversteeg/min/gh-pages/compiled/navbar.css */\n    .nav,\n    .nav .current,\n    .nav a:hover {\n      background: #000;\n      color: #fff;\n    }\n    .nav {\n      height: 24px;\n      padding: 11px 0 15px;\n      /* TODO: migrate to ems (currently we don't use them because of iOS compatibility problems (has to do with unicode icon for close)) */\n      /* Uncomment for animations\n      max-height: 1.5em;\n      */\n    }\n    .nav a {\n      color: #aaa;\n      padding-right: 1em;\n      position: relative;\n      top: -1px;\n    }\n    .nav .pagename {\n      font-size: 22px;\n      top: 1px;\n    }\n    .btn.btn-close {\n      background: #000;\n      float: right;\n      font-size: 25px;\n      margin: -54px 7px;\n      display: none;\n    }\n    @media (max-width: 500px) {\n      .btn.btn-close {\n        display: block;\n      }\n      .nav {\n        /* transition: max-height .5s ease-in-out, height .5s ease-in-out; */\n        overflow: hidden;\n      }\n      .pagename {\n        margin-top: -11px;\n      }\n      .nav:active,\n      .nav:focus {\n        height: auto;\n        /* Necesary for animations\n        max-height: 500px;\n        height: 100%;\n        */\n      }\n      .nav div:before {\n        background: #000;\n        border-bottom: 10px double;\n        border-top: 3px solid;\n        content: '';\n        float: right;\n        height: 4px;\n        position: relative;\n        right: 3px;\n        top: 14px;\n        width: 20px;\n      }\n      .nav a {\n        display: block;\n        padding: .5em 0;\n        width: 50%;\n      }\n    }\n\n    /* Custom Apage: Navigation */\n    .nav .index  { text-transform:uppercase; }\n    .nav .active { color:#fff; }\n\n    /* Custom Apage: Definition List */\n    dl, dt, dd { display:inline-block; margin:0; color:#eee }\n    dl { margin-top: .5rem; padding:.5em 1em .4em; background: #333; border-radius:3px }\n    dt { text-transform:uppercase; font-size: .7rem; }\n    dt:after { content:\": \" }\n\n    p, ul, ol { line-height:1.4; }\n";
  };

  filterLine = function(config, line) {
    var rx;
    if (config.url) {
      rx = new RegExp('href="' + config.url, 'g');
      line = line.replace(rx, 'href="');
    }
    return "          '" + line + "',";
  };

  tidypath = function(p) {
    var name, order;
    name = filename(p).split('-');
    order = name[0];
    name = isNaN(order * 1) ? name.join('-') : name.slice(1).join('-');
    return dirname(p) + name.split('.').slice(0, -1).join('.');
  };

  dirname = function(p) {
    return ªhas(p, '/', p.split('/').slice(0, -1).join('/') + '/', '');
  };

  filename = function(p) {
    return p.split('/').slice(-1)[0];
  };

  ordername = function(p) {
    var order;
    order = filename(p).split('-')[0];
    if (isNaN(order * 1)) {
      return "'" + order + "'";
    } else {
      return order * 1;
    }
  };

  script = function(config, articles) {
    var article, field, i, j, k, l, len, len1, len2, line, out, ref, ref1;
    out = ['!function (root) { \'use strict\';', '  var', '', '    //// Define the articles. ', '    arts = ['];
    for (i = j = 0, len = articles.length; j < len; i = ++j) {
      article = articles[i];
      out = out.concat(["      { order: " + (ordername(article.path)) + ",", "        path:  '/" + article.path + "',", "        tidy:  '/" + (tidypath(article.path)) + "',", "        dname: '/" + (dirname(article.path)) + "',", "        title: '" + article.title + "',", "        meta: ["]);
      ref = article.meta;
      for (k = 0, len1 = ref.length; k < len1; k++) {
        field = ref[k];
        out.push("          ['" + field.key + "','" + field.value + "'],");
      }
      out = out.concat(["        ],", "        html: ["]);
      ref1 = article.html;
      for (l = 0, len2 = ref1.length; l < len2; l++) {
        line = ref1[l];
        out.push(filterLine(config, line));
      }
      out = out.concat(["        ]", "      },"]);
    }
    out = out.concat(["    ]\n\n\n    //// Format meta data as HTML. \n   ,formatMeta = function (meta) {\n      var o=['<div class=\"meta\">'];\n      for (var i=0,l=meta.length; i<l; i++) {\n        o = o.concat(\n          '  <dl>'\n         ,'    <dt>' + meta[i][0] + '</dt>'\n         ,'    <dd>' + meta[i][1] + '</dd>'\n         ,'  </dl>'\n        );\n      }\n      return o.concat('</div>').join('\\n');\n    }\n\n\n    //// Generate the menu as HTML. \n   ,formatMenu = function (curr) {\n      var o=['<div class=\"menu\">'];\n      for (var i=0,l=arts.length,a,c; i<l; i++) {\n        a = arts[i];\n        c = [];\n        if (0 === a.order)        { c.push('index'); }\n        if (curr.tidy === a.tidy) { c.push('active'); }\n        if (0 === a.order || curr.dname === a.dname) {\n          o.push(\n            '  <a href=\"#' + a.tidy + '\" ' +\n            ' class=\"' + c.join(' ') + '\">' +\n            a.title + '</a>'\n          );\n        }\n      }\n      return o.concat('</div>').join('\\n');\n    }\n\n\n    //// One-liner jQuery ;-)\n   ,$ = function (s) { return document.querySelector(s); }\n\n\n    //// Return a renderable object based on a given query. \n   ,resolve = function (query) {\n      if (! query) { return arts[0]; } // eg '#' or no hash\n      if (arts[query]) { return arts[query]; } // eg '#57' or '#/foo'\n    }\n\n\n    //// Change the window content, eg display an article. \n   ,update = function (query) {\n      var a = resolve(query) || arts.undefined;\n      $('.content').innerHTML =\n          a.html.join('\\n') +\n          '\\n<hr>\\n' +\n          formatMeta(a.meta)\n      ;\n      $('.nav .container').innerHTML = formatMenu(a);\n      document.title = a.title;\n    }\n\n\n    //// Called when the page loads, and when the URL hash changes. \n   ,onHashchange = function (event) {\n      update( window.location.hash.substr(1) ); // trim leading '#'\n      event.preventDefault();\n    }\n\n\n  ;\n\n  //// Add default articles. \n  arts['/'] = arts[0]; // define homepage at 'example.com/#/'\n  arts.undefined = {\n    order: 0,\n    path:  '',\n    tidy:  '',\n    dname: '',\n    title: 'Article Not Found',\n    meta: [],\n    html: ['<h1>Article Not Found</h1>']\n  };\n\n\n  //// Allow articles to be queried '#/with/a/path'. \n  for (var i=0,l=arts.length; i<l; i++) { arts[ arts[i].tidy ] = arts[i]; }\n\n\n  //// Show the article specified in the URL, when the page loads...\n  window.addEventListener('load', onHashchange);\n\n\n  //// ...and when the URL hash changes. \n  window.addEventListener('hashchange', onHashchange);\n\n\n}(this);"]);
    return out.join('\n');
  };

}).call(this);
