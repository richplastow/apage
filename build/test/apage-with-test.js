// Generated by CoffeeScript 1.9.1

/*! Apage 0.0.6 //// MIT Licence //// http://apage.richplastow.com/ */

(function() {
  var Article, Main, Tudor, header, marked, script, style, tudor, ª, ªA, ªB, ªE, ªF, ªI, ªN, ªO, ªR, ªS, ªU, ªV, ªX, ªclone, ªpopulate, ªtype,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  ªI = 'Apage';

  ªV = '0.0.6';

  ªA = 'array';

  ªB = 'boolean';

  ªE = 'error';

  ªF = 'function';

  ªN = 'number';

  ªO = 'object';

  ªR = 'regexp';

  ªS = 'string';

  ªU = 'undefined';

  ªX = 'null';

  ª = console.log.bind(console);

  ªtype = function(x) {
    return {}.toString.call(x).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
  };

  ªpopulate = function(candidate, subject, rules, updating) {
    var errors, j, k, key, len, len1, rule, test, type, use, value;
    if (ªO !== ªtype(candidate)) {
      return ["`candidate` is type '" + (ªtype(candidate)) + "' not 'object'"];
    }
    errors = [];
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (updating || void 0 !== use) {
          continue;
        } else {
          errors.push("Missing field '" + key + "' is mandatory");
        }
      } else if (type !== ªtype(value)) {
        errors.push("Field '" + key + "' is type '" + (ªtype(value)) + "' not '" + type + "'");
      } else if (!test.test(value)) {
        errors.push("Field '" + key + "' fails " + ('' + test));
      }
    }
    if (errors.length) {
      return errors;
    }
    for (k = 0, len1 = rules.length; k < len1; k++) {
      rule = rules[k];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (void 0 === subject[key]) {
          subject[key] = use;
        }
      } else {
        subject[key] = value;
      }
    }
  };

  ªclone = function(subject, rules) {
    var j, key, len, out, rule;
    out = {};
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0];
      out[key] = subject[key];
    }
    return out;
  };

  Article = (function() {
    Article.prototype.I = 'Article';

    Article.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Article.prototype._rules = {
      config: [['path', void 0, 'string', /^[-.\/a-zA-Z0-9]{1,64}$/], ['raw', '@todo\n=====\n', 'string', /^[^\x00-\x08\x0E-\x1F]{0,10000}$/]]
    };

    function Article(config) {
      var errors;
      if (config == null) {
        config = {};
      }
      this._config = {};
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
      this.path = this._config.path;
      this.title = (this._config.raw.split('\n'))[0];
      this.html = (marked(this._config.raw)).replace(/\\/g, '\\\\').split('\n');
    }

    Article.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    return Article;

  })();

  Main = (function() {
    Main.prototype.I = ªI;

    Main.prototype.V = ªV;

    Main.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Main.prototype._rules = {
      config: [['title', 'Untitled', 'string', /^[^\x00-\x1F]{1,24}$/]]
    };

    function Main(config) {
      var errors;
      if (config == null) {
        config = {};
      }
      this._config = {};
      this._articles = [];
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
    }

    Main.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    Main.prototype.append = function(article) {
      if (!article) {
        return this;
      }
      this._articles.push(new Article(article));
      return this;
    };

    Main.prototype.render = function() {
      return (header(this._config, this._articles)) + "\n</body>\n</html>\n";
    };

    return Main;

  })();

  if (ªF === typeof define && define.amd) {
    define(function() {
      return Main;
    });
  } else if (ªO === typeof module && module && module.exports) {
    module.exports = Main;
  } else {
    this[ªI] = Main;
  }

  if (ªF === typeof define && define.amd) {

  } else if (ªO === typeof module && module && module.exports) {
    marked = require('marked');
  } else {
    marked = window.marked;
  }

  marked.setOptions({});

  header = function(config, articles) {
    return "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title>" + config.title + "</title>\n  <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\">\n  <style>\n    " + (style(config)) + "\n  </style>\n  <script>\n    " + (script(articles)) + "\n  </script>\n</head>\n<body>\n  <h1>" + config.title + "</h1>";
  };

  style = function(config) {
    return "/* normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */\n\n    /* Document */\n    html { font-family:sans-serif; -ms-text-size-adjust:100%; -webkit-text-size-adjust:100% }\n    body { margin:0 }\n\n    /* HTML5 */\n    article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,\n    section,summary { display: block }\n    audio,canvas,progress,video { display:inline-block; vertical-align:baseline }\n    audio:not([controls]) { display:none; height:0 }\n    [hidden],template { display:none }\n\n    /* Links */\n    a { background-color:transparent }\n    a:active,a:hover { outline:0 }\n\n    /* Text */\n    abbr[title] { border-bottom: 1px dotted }\n    b, strong { font-weight: bold }\n    dfn { font-style: italic }\n    h1 { font-size: 2em; margin: 0.67em 0 }\n    mark { background: #ff0; color: #000 }\n    small { font-size: 80% }\n    sub,sup { font-size:75%; line-height:0; position:relative; vertical-align:baseline }\n    sup { top: -0.5em }\n    sub { bottom: -0.25em }\n\n    /* Embedded */\n    img { border: 0 }\n    svg:not(:root) { overflow: hidden }\n\n    /* Grouping */\n    figure { margin: 1em 40px }\n    hr { box-sizing: content-box; height: 0 }\n    pre { overflow: auto }\n    code,kbd,pre,samp { font-family:monospace,monospace; font-size:1em }\n\n    /* Forms */\n    button,input,optgroup,select,textarea { color:inherit; font:inherit; margin:0 }\n    button { overflow:visible }\n    button,select { text-transform:none }\n    button,html input[type=\"button\"],input[type=\"reset\"],\n    input[type=\"submit\"] { -webkit-appearance:button; cursor:pointer }\n    button[disabled],html input[disabled] { cursor:default }\n    button::-moz-focus-inner,input::-moz-focus-inner{ border:0; padding:0 }\n    input { line-height:normal }\n    input[type=\"checkbox\"],input[type=\"radio\"] { box-sizing:border-box; padding:0 }\n    input[type=\"number\"]::-webkit-inner-spin-button,\n    input[type=\"number\"]::-webkit-outer-spin-button { height:auto }\n    input[type=\"search\"] { -webkit-appearance:textfield; box-sizing:content-box }\n    input[type=\"search\"]::-webkit-search-cancel-button,\n    input[type=\"search\"]::-webkit-search-decoration { -webkit-appearance:none }\n    fieldset { border:1px solid #c0c0c0; margin:0 2px; padding:0.35em 0.625em 0.75em }\n    legend { border:0; padding:0 }\n    textarea { overflow:auto }\n    optgroup { font-weight:bold }\n\n    /* Tables */\n    table { border-collapse:collapse; border-spacing:0 }\n    td,th { padding:0 }\n";
  };

  script = function(articles) {
    var article, i, j, k, len, len1, line, out, ref;
    out = ["//// Generated by " + ªI + " " + ªV + " //// http://apage.richplastow.com/", '', '!function (root) { \'use strict\';', '', '  var', '', '    //// Declare variables. ', '    i, l, o, art // iterator, length, output, article', '', '', '    //// Define content. ', '   ,arts = [ // articles'];
    for (i = j = 0, len = articles.length; j < len; i = ++j) {
      article = articles[i];
      out = out.concat(["      { path: '/" + article.path + "',", "        title: '" + article.title + "',", "        html: ["]);
      ref = article.html;
      for (k = 0, len1 = ref.length; k < len1; k++) {
        line = ref[k];
        out.push("          '" + line + "',");
      }
      out.push("        ]");
      out.push("      },");
    }
    out = out.concat(['    ]', '', '', '    //// Build the menu. ', '   ,menu = (function () {', "      o = [];", '      for (i=0, l=arts.length; i<l; i++) {', '        art = arts[i];', "        o.push('<li><a href=\"#' + art.path + '\">' + art.title + '</a>');", '      }', "      return '<ul class=\"menu\">\\n' + o.join('\\n') + '\\n</ul>\\n';", '    })()', '', '', '    //// One-liner jQuery ;-)', '   ,$ = function (s) { return document.querySelector(s); }', '', '', '    //// Return a renderable object based on a given query. ', '   ,resolve = function (query) {', "      if (! query) { return arts[0]; } // eg '#' or no hash", "      if (arts[query]) { return arts[query]; } // eg '#57' or '#/foo'", '    }', '', '', '    //// Change the window content, eg display an article. ', '   ,update = function (query) {', "      $('body').innerHTML =", "          menu + '\\n'", "        + (resolve(query) || arts.undefined).html.join('\\n')", '      ;', '    }', '', '', '    //// Called when the page loads, and when the URL hash changes. ', '   ,onHashchange = function (event) {', "      update( window.location.hash.substr(1) ); // trim leading '#'", '      event.preventDefault();', '    }', '', '', '  ;', '', '', '  //// Add default articles. ', "  arts['/'] = arts[0]; // define homepage at 'example.com/#/'", '  arts.undefined = {', "    path:'',", "    html: ['<h1>Article Not Found</h1>']", '  };', '', '', "  //// Allow articles to be queried '#/with/a/path'. ", '  for (i=0, l=arts.length; i<l; i++) {', '    art = arts[i];', '    arts[ art.path ] = art;', '  }', '', '', '  //// Show the article specified in the URL, when the page loads... ', '  window.addEventListener(\'load\', onHashchange);', '', '', '  //// ...and when the URL hash changes. ', '  window.addEventListener(\'hashchange\', onHashchange);', '', '', '}(this);', '']);
    return out.join('\n    ');
  };

  Tudor = (function() {
    var invisibles;

    Tudor.prototype.I = 'Tudor';

    Tudor.prototype.toString = function() {
      return "[object " + I + "]";
    };

    Tudor.prototype.jobs = [];

    function Tudor(opt) {
      if (opt == null) {
        opt = {};
      }
      this["do"] = bind(this["do"], this);
      switch (opt.format) {
        case 'html':
          this.header = '<a href="#end" id="top">\u2b07</a>';
          this.footer = '\n<a href="#top" id="end">\u2b06</a>';
          break;
        default:
          this.header = '\u2b07';
          this.footer = '\n\u2b06';
      }
    }

    Tudor.prototype["do"] = function() {
      var actual, double, expect, j, job, len, md, name, ref, result, runner, summary, tallies;
      md = [];
      tallies = [0, 0];
      double = null;
      ref = this.jobs;
      for (j = 0, len = ref.length; j < len; j++) {
        job = ref[j];
        switch (ªtype(job)) {
          case ªF:
            double = job(double);
            break;
          case ªS:
            md.push(job);
            break;
          case ªA:
            runner = job[0], name = job[1], expect = job[2], actual = job[3];
            result = runner(expect, actual, double);
            if (!result) {
              md.push("\u2713 " + name + "  ");
              tallies[0]++;
            } else {
              md.push("\u2718 " + name + "  ");
              md.push("    " + result + "  ");
              tallies[1]++;
            }
        }
        summary = "  passed " + tallies[0] + "/" + (tallies[0] + tallies[1]) + " ";
        summary += tallies[1] ? '\u2718' : '\u2714';
      }
      md.unshift(this.header + summary);
      md.push(this.footer + summary);
      return md.join('\n');
    };

    Tudor.prototype.page = function(text) {
      return this.jobs.push(("\n\n" + text + "\n=") + (new Array(text.length).join('=')));
    };

    Tudor.prototype.section = function(text) {
      return this.jobs.push(("\n\n" + text + "\n-") + (new Array(text.length).join('-')) + '\n');
    };

    Tudor.prototype.fail = function(result, delivery, expect, types) {
      if (types) {
        result = (invisibles(result)) + " (" + (ªtype(result)) + ")";
        expect = (invisibles(expect)) + " (" + (ªtype(expect)) + ")";
      }
      return (invisibles(result)) + "\n    ...was " + delivery + ", but expected...\n    " + (invisibles(expect));
    };

    invisibles = function(value) {
      return value != null ? value.toString().replace(/^\s+|\s+$/g, function(match) {
        return '\u00b7' + (new Array(match.length)).join('\u00b7');
      }) : void 0;
    };

    Tudor.prototype.custom = function(al, runner) {
      var i;
      i = 0;
      while (i < al.length) {
        if (ªF === ªtype(al[i])) {
          this.jobs.push(al[i]);
        } else {
          this.jobs.push([runner, al[i], al[++i], al[++i]]);
        }
        i++;
      }
      return this.jobs.push('- - -');
    };

    Tudor.prototype.throws = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, double) {
          var e, error;
          error = false;
          try {
            actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (!error) {
            return "No exception thrown, expected...\n    " + expect;
          } else if (expect !== error) {
            return _this.fail(error, 'thrown', expect);
          }
        };
      })(this));
    };

    Tudor.prototype.equal = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, double) {
          var e, error, result;
          error = false;
          try {
            result = actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (error) {
            return "Unexpected exception...\n    " + error;
          } else if (expect !== result) {
            return _this.fail(result, 'returned', expect, result + '' === expect + '');
          }
        };
      })(this));
    };

    Tudor.prototype.is = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, double) {
          var e, error, result;
          error = false;
          try {
            result = actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (error) {
            return "Unexpected exception...\n    " + error;
          } else if (expect !== ªtype(result)) {
            return _this.fail("type " + (ªtype(result)), 'returned', "type " + expect);
          }
        };
      })(this));
    };

    return Tudor;

  })();

  tudor = new Tudor({
    format: ªO === typeof window ? 'html' : 'plain'
  });

  Main.runTest = tudor["do"];

  tudor.page("`Apage` Constructor Usage");

  tudor.section("No `config` Argument");

  tudor.is([
    "Class is a function", ªF, function() {
      return Main;
    }, function() {
      return new Main;
    }, "Instance is an object", ªO, function(mock) {
      return mock;
    }
  ]);

  tudor.equal([
    "`toString()` is '[object Apage]'", '[object Apage]', function(mock) {
      return '' + mock;
    }, "`config` is null", '[object Apage]', function() {
      return '' + new Main(null);
    }
  ]);

  tudor.section("Basic `config`");

  tudor.equal([
    "Set the title", '[object Apage]', function() {
      return '' + new Main({
        title: 'Café'
      });
    }
  ]);

  tudor.page("`Apage` Constructor Errors");

  tudor.section("Invalid `config` Argument");

  tudor.throws([
    "`config` is not an object", "Invalid `config`:\n  `candidate` is type 'number' not 'object'", function() {
      return new Main(1);
    }, "`config` is a `Date` object", "Invalid `config`:\n  `candidate` is type 'date' not 'object'", function() {
      return new Main(new Date);
    }, "`config` is a `String` object", "Invalid `config`:\n  `candidate` is type 'string' not 'object'", function() {
      return new Main(new String('yikes!'));
    }
  ]);

  tudor.section("Invalid `config.title`");

  tudor.throws([
    "A number", "Invalid `config`:\n  Field 'title' is type 'number' not 'string'", function() {
      return new Main({
        title: 0
      });
    }, "An empty string", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: ''
      });
    }, "25 characters long", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: '1234567890123456789012345'
      });
    }, "Contains a tab", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: 'tab character: \t'
      });
    }
  ]);

  tudor.page("`apage.config()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`config()` is a function", ªF, function(mock) {
      return mock.config;
    }, "Returns an object", ªO, function(mock) {
      return mock.config();
    }
  ]);

  tudor.equal([
    "Returned object contains expected defaults", '{"title":"Untitled"}', function(mock) {
      return JSON.stringify(mock.config());
    }, "Returns a new object each time", false, function(mock) {
      return mock.config() === mock.config();
    }
  ]);

  tudor.section("Retrieve a config value");

  tudor.equal([
    "Default `title` is 'Untitled'", 'Untitled', function(mock) {
      return mock.config('title');
    }, function() {
      return new Main({
        title: '外国語の学習と教授'
      });
    }, "After constructing with Japanese `title`", '外国語の学習と教授', function(mock) {
      return mock.config('title');
    }, "Key not recognized", void 0, function(mock) {
      return mock.config('unrecognized');
    }
  ]);

  tudor.section("Set a valid config value");

  tudor.equal([
    "Set a Chinese `title`, two arg syntax, returns `undefined`", void 0, function(mock) {
      return mock.config('title', '語文教學・语文教学');
    }, "Check that Chinese `title` has been set", '語文教學・语文教学', function(mock) {
      return mock.config('title');
    }, "Set a Greek `title`, object syntax, returns `undefined`", void 0, function(mock) {
      return mock.config({
        title: 'Γλωσσική Εκμὰθηση'
      });
    }, "Check that Greek `title` has been set", 'Γλωσσική Εκμὰθηση', function(mock) {
      return mock.config('title');
    }
  ]);

  tudor.section("Set an invalid config value");

  tudor.is([
    "Returns an array", ªA, function(mock) {
      return mock.config('title', '');
    }
  ]);

  tudor.equal([
    "The array has one element", 1, function(mock) {
      return (mock.config('title', '')).length;
    }, "The array element is an expected error message", "Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function(mock) {
      return (mock.config('title', ''))[0];
    }
  ]);

  tudor.page("`apage.render()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`render()` is a function", ªF, function(mock) {
      return mock.render;
    }, "Returns a string", ªS, function(mock) {
      return mock.render();
    }
  ]);

  tudor.equal([
    "Returned string is expected length", 4872, function(mock) {
      return mock.render().length;
    }, "Shorter `title` changes string length", 4860, function(mock) {
      mock.config('title', 'OK');
      return mock.render().length;
    }
  ]);

  tudor.page("`apage.append()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`append()` is a function", ªF, function(mock) {
      return mock.append;
    }, "Returns an object", ªO, function(mock) {
      return mock.append();
    }
  ]);

  tudor.equal([
    "Returned object is the instance itself", true, function(mock) {
      return mock.append() === mock;
    }, "The `path` field is rendered to inline script", 2945, function(mock) {
      return mock.append({
        path: 'abcxyz'
      }).render().indexOf('abcxyz');
    }, "Default `html` field is rendered to inline script", 2974, function(mock) {
      return mock.render().indexOf('@todo');
    }, "`html` field is parsed by markdown", 3017, function(mock) {
      return mock.render().indexOf('<h1 id="-todo">@todo</h1>');
    }
  ]);

  tudor.page("`apage.append()` Errors");

  tudor.section("Invalid `article` argument");

  tudor.throws([
    "`config` is a number", "Invalid `config`:\n  `candidate` is type 'number' not 'object'", function(mock) {
      return mock.append(456);
    }
  ]);

  tudor.section("Invalid `path` field");

  tudor.throws([
    "`path` is not set", "Invalid `config`:\n  Missing field 'path' is mandatory", function(mock) {
      return mock.append({});
    }, "`path` is a boolean", "Invalid `config`:\n  Field 'path' is type 'boolean' not 'string'", function(mock) {
      return mock.append({
        path: true
      });
    }, "`path` is an empty string", "Invalid `config`:\n  Field 'path' fails /^[-.\\/a-zA-Z0-9]{1,64}$/", function(mock) {
      return mock.append({
        path: ''
      });
    }, "`path` is too long", "Invalid `config`:\n  Field 'path' fails /^[-.\\/a-zA-Z0-9]{1,64}$/", function(mock) {
      return mock.append({
        path: (new Array(66)).join('-')
      });
    }, "`path` contains an invalid character", "Invalid `config`:\n  Field 'path' fails /^[-.\\/a-zA-Z0-9]{1,64}$/", function(mock) {
      return mock.append({
        path: 'a\\b'
      });
    }
  ]);

  tudor.section("Invalid `raw` field");

  tudor.throws([
    "`raw` is an object", "Invalid `config`:\n  Field 'raw' is type 'object' not 'string'", function(mock) {
      return mock.append({
        path: 'a',
        raw: {}
      });
    }, "`raw` is too long", "Invalid `config`:\n  Field 'raw' fails /^[^\\x00-\\x08\\x0E-\\x1F]{0,10000}$/", function(mock) {
      return mock.append({
        path: 'c',
        raw: (new Array(10002)).join('-')
      });
    }, "`raw` contains an invalid character", "Invalid `config`:\n  Field 'raw' fails /^[^\\x00-\\x08\\x0E-\\x1F]{0,10000}$/", function(mock) {
      return mock.append({
        path: 'd',
        raw: 'x\bz'
      });
    }
  ]);

}).call(this);
