// Generated by CoffeeScript 1.9.1

/*! Apage 0.0.3 //// MIT Licence //// http://apage.richplastow.com/ */

(function() {
  var A, B, E, F, I, Main, N, O, R, S, Tudor, U, V, X, header, style, tudor, ª,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  I = 'Apage';

  V = '0.0.3';

  A = 'array';

  B = 'boolean';

  E = 'error';

  F = 'function';

  N = 'number';

  O = 'object';

  R = 'regexp';

  S = 'string';

  U = 'undefined';

  X = 'null';

  ª = console.log.bind(console);

  ª.type = function(x) {
    return {}.toString.call(x).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
  };

  ª.populate = function(candidate, subject, rules, updating) {
    var errors, j, k, key, len, len1, rule, test, type, use, value;
    if (O !== ª.type(candidate)) {
      return ["`candidate` is type '" + (ª.type(candidate)) + "' not 'object'"];
    }
    errors = [];
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (updating || void 0 !== use) {
          continue;
        } else {
          errors.push("Missing key '" + key + "' is mandatory");
        }
      } else if (type !== ª.type(value)) {
        errors.push("Key '" + key + "' is type '" + (ª.type(value)) + "' not '" + type + "'");
      } else if (!test.test(value)) {
        errors.push("Key '" + key + "' fails " + ('' + test));
      }
    }
    if (errors.length) {
      return errors;
    }
    for (k = 0, len1 = rules.length; k < len1; k++) {
      rule = rules[k];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (void 0 === subject[key]) {
          subject[key] = use;
        }
      } else {
        subject[key] = value;
      }
    }
  };

  ª.clone = function(subject, rules) {
    var j, key, len, out, rule;
    out = {};
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0];
      out[key] = subject[key];
    }
    return out;
  };

  Main = (function() {
    Main.prototype.I = I;

    Main.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Main.prototype._rules = {
      config: [['title', 'Untitled', 'string', /^[^\x00-\x1F]{1,24}$/]]
    };

    function Main(config) {
      var errors;
      if (config == null) {
        config = {};
      }
      this._c = {};
      if (errors = ª.populate(config, this._c, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
    }

    Main.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ª.clone(this._c, this._rules.config);
        case 1:
          switch (ª.type(key)) {
            case S:
              return this._c[key];
            case O:
              return ª.populate(key, this._c, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    Main.prototype.render = function() {
      return header(this._c);
    };

    return Main;

  })();

  if (F === typeof define && define.amd) {
    define(function() {
      return Main;
    });
  } else if (O === typeof module && module && module.exports) {
    module.exports = Main;
  } else {
    this[I] = Main;
  }

  header = function(config) {
    return "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title>" + config.title + "</title>\n  <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\">\n  <style>\n    " + (style()) + "\n  </style>\n</head>\n<body>\n  <h1>" + config.title + "</h1>";
  };

  style = function() {
    return "/* normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */\n\n    /* Document */\n    html { font-family:sans-serif; -ms-text-size-adjust:100%; -webkit-text-size-adjust:100% }\n    body { margin:0 }\n\n    /* HTML5 */\n    article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,\n    section,summary { display: block }\n    audio,canvas,progress,video { display:inline-block; vertical-align:baseline }\n    audio:not([controls]) { display:none; height:0 }\n    [hidden],template { display:none }\n\n    /* Links */\n    a { background-color:transparent }\n    a:active,a:hover { outline:0 }\n\n    /* Text */\n    abbr[title] { border-bottom: 1px dotted }\n    b, strong { font-weight: bold }\n    dfn { font-style: italic }\n    h1 { font-size: 2em; margin: 0.67em 0 }\n    mark { background: #ff0; color: #000 }\n    small { font-size: 80% }\n    sub,sup { font-size:75%; line-height:0; position:relative; vertical-align:baseline }\n    sup { top: -0.5em }\n    sub { bottom: -0.25em }\n\n    /* Embedded */\n    img { border: 0 }\n    svg:not(:root) { overflow: hidden }\n\n    /* Grouping */\n    figure { margin: 1em 40px }\n    hr { box-sizing: content-box; height: 0 }\n    pre { overflow: auto }\n    code,kbd,pre,samp { font-family:monospace,monospace; font-size:1em }\n\n    /* Forms */\n    button,input,optgroup,select,textarea { color:inherit; font:inherit; margin:0 }\n    button { overflow:visible }\n    button,select { text-transform:none }\n    button,html input[type=\"button\"],input[type=\"reset\"],\n    input[type=\"submit\"] { -webkit-appearance:button; cursor:pointer }\n    button[disabled],html input[disabled] { cursor:default }\n    button::-moz-focus-inner,input::-moz-focus-inner{ border:0; padding:0 }\n    input { line-height:normal }\n    input[type=\"checkbox\"],input[type=\"radio\"] { box-sizing:border-box; padding:0 }\n    input[type=\"number\"]::-webkit-inner-spin-button,\n    input[type=\"number\"]::-webkit-outer-spin-button { height:auto }\n    input[type=\"search\"] { -webkit-appearance:textfield; box-sizing:content-box }\n    input[type=\"search\"]::-webkit-search-cancel-button,\n    input[type=\"search\"]::-webkit-search-decoration { -webkit-appearance:none }\n    fieldset { border:1px solid #c0c0c0; margin:0 2px; padding:0.35em 0.625em 0.75em }\n    legend { border:0; padding:0 }\n    textarea { overflow:auto }\n    optgroup { font-weight:bold }\n\n    /* Tables */\n    table { border-collapse:collapse; border-spacing:0 }\n    td,th { padding:0 }\n";
  };

  Tudor = (function() {
    var invisibles;

    Tudor.prototype.I = 'Tudor';

    Tudor.prototype.toString = function() {
      return "[object " + I + "]";
    };

    Tudor.prototype.jobs = [];

    function Tudor(opt) {
      if (opt == null) {
        opt = {};
      }
      this["do"] = bind(this["do"], this);
      switch (opt.format) {
        case 'html':
          this.header = '<a href="#end" id="top">\u2b07</a>';
          this.footer = '\n<a href="#top" id="end">\u2b06</a>';
          break;
        default:
          this.header = '\u2b07';
          this.footer = '\n\u2b06';
      }
    }

    Tudor.prototype["do"] = function() {
      var actual, double, expect, j, job, len, md, name, ref, result, runner, summary, tallies;
      md = [];
      tallies = [0, 0];
      double = null;
      ref = this.jobs;
      for (j = 0, len = ref.length; j < len; j++) {
        job = ref[j];
        switch (ª.type(job)) {
          case 'function':
            double = job(double);
            break;
          case 'string':
            md.push(job);
            break;
          case 'array':
            runner = job[0], name = job[1], expect = job[2], actual = job[3];
            result = runner(expect, actual, double);
            if (!result) {
              md.push("\u2713 " + name + "  ");
              tallies[0]++;
            } else {
              md.push("\u2718 " + name + "  ");
              md.push("    " + result + "  ");
              tallies[1]++;
            }
        }
        summary = "  passed " + tallies[0] + "/" + (tallies[0] + tallies[1]) + " ";
        summary += tallies[1] ? '\u2718' : '\u2714';
      }
      md.unshift(this.header + summary);
      md.push(this.footer + summary);
      return md.join('\n');
    };

    Tudor.prototype.page = function(text) {
      return this.jobs.push(("\n\n" + text + "\n=") + (new Array(text.length).join('=')));
    };

    Tudor.prototype.section = function(text) {
      return this.jobs.push(("\n\n" + text + "\n-") + (new Array(text.length).join('-')) + '\n');
    };

    Tudor.prototype.custom = function(tests, runner) {
      var i;
      i = 0;
      while (i < tests.length) {
        if ('function' === ª.type(tests[i])) {
          this.jobs.push(tests[i]);
        } else {
          this.jobs.push([runner, tests[i], tests[++i], tests[++i]]);
        }
        i++;
      }
      return this.jobs.push('- - -');
    };

    Tudor.prototype.fail = function(result, delivery, expect, types) {
      if (types) {
        result = (invisibles(result)) + " (" + (ª.type(result)) + ")";
        expect = (invisibles(expect)) + " (" + (ª.type(expect)) + ")";
      }
      return (invisibles(result)) + "\n    ...was " + delivery + ", but expected...\n    " + (invisibles(expect));
    };

    invisibles = function(value) {
      return value != null ? value.toString().replace(/^\s+|\s+$/g, function(match) {
        return '\u00b7' + (new Array(match.length)).join('\u00b7');
      }) : void 0;
    };

    Tudor.prototype.throws = function(tests) {
      return this.custom(tests, (function(_this) {
        return function(expect, actual, double) {
          var e, error;
          error = false;
          try {
            actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (!error) {
            return "No exception thrown, expected...\n    " + expect;
          } else if (expect !== error) {
            return _this.fail(error, 'thrown', expect);
          }
        };
      })(this));
    };

    Tudor.prototype.equal = function(tests) {
      return this.custom(tests, (function(_this) {
        return function(expect, actual, double) {
          var e, error, result;
          error = false;
          try {
            result = actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (error) {
            return "Unexpected exception...\n    " + error;
          } else if (expect !== result) {
            return _this.fail(result, 'returned', expect, result + '' === expect + '');
          }
        };
      })(this));
    };

    Tudor.prototype.is = function(tests) {
      return this.custom(tests, (function(_this) {
        return function(expect, actual, double) {
          var e, error, result;
          error = false;
          try {
            result = actual(double);
          } catch (_error) {
            e = _error;
            error = e.message;
          }
          if (error) {
            return "Unexpected exception...\n    " + error;
          } else if (expect !== ª.type(result)) {
            return _this.fail("type " + (ª.type(result)), 'returned', "type " + expect);
          }
        };
      })(this));
    };

    return Tudor;

  })();

  tudor = new Tudor({
    format: O === typeof window ? 'html' : 'plain'
  });

  Main.runTest = tudor["do"];

  tudor.page("`Apage` Constructor Usage");

  tudor.section("No `config` Argument");

  tudor.is([
    "Class is a function", F, function() {
      return Main;
    }, function() {
      return new Main;
    }, "Instance is an object", O, function(mock) {
      return mock;
    }
  ]);

  tudor.equal([
    "`toString()` is '[object Apage]'", '[object Apage]', function(mock) {
      return '' + mock;
    }, "`config` is null", '[object Apage]', function() {
      return '' + new Main(null);
    }
  ]);

  tudor.section("Basic `config`");

  tudor.equal([
    "Set the title", '[object Apage]', function() {
      return '' + new Main({
        title: 'Café'
      });
    }
  ]);

  tudor.page("`Apage` Constructor Errors");

  tudor.section("Invalid `config` Argument");

  tudor.throws([
    "`config` is not an object", "Invalid `config`:\n  `candidate` is type 'number' not 'object'", function() {
      return new Main(1);
    }, "`config` is a `Date` object", "Invalid `config`:\n  `candidate` is type 'date' not 'object'", function() {
      return new Main(new Date);
    }, "`config` is a `String` object", "Invalid `config`:\n  `candidate` is type 'string' not 'object'", function() {
      return new Main(new String('yikes!'));
    }
  ]);

  tudor.section("Invalid `config.title`");

  tudor.throws([
    "A number", "Invalid `config`:\n  Key 'title' is type 'number' not 'string'", function() {
      return new Main({
        title: 0
      });
    }, "An empty string", "Invalid `config`:\n  Key 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: ''
      });
    }, "25 characters long", "Invalid `config`:\n  Key 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: '1234567890123456789012345'
      });
    }, "Contains a tab", "Invalid `config`:\n  Key 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: 'tab character: \t'
      });
    }
  ]);

  tudor.page("`apage.config()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`config()` is a function", F, function(mock) {
      return mock.config;
    }, "Returns an object", O, function(mock) {
      return mock.config();
    }
  ]);

  tudor.equal([
    "Returned object contains expected defaults", '{"title":"Untitled"}', function(mock) {
      return JSON.stringify(mock.config());
    }, "Returns a new object each time", false, function(mock) {
      return mock.config() === mock.config();
    }
  ]);

  tudor.section("Retrieve a config value");

  tudor.equal([
    "Default `title` is 'Untitled'", 'Untitled', function(mock) {
      return mock.config('title');
    }, function() {
      return new Main({
        title: '外国語の学習と教授'
      });
    }, "After constructing with Japanese `title`", '外国語の学習と教授', function(mock) {
      return mock.config('title');
    }, "Key not recognized", void 0, function(mock) {
      return mock.config('unrecognized');
    }
  ]);

  tudor.section("Set a valid config value");

  tudor.equal([
    "Set a Chinese `title`, two arg syntax, returns `undefined`", void 0, function(mock) {
      return mock.config('title', '語文教學・语文教学');
    }, "Check that Chinese `title` has been set", '語文教學・语文教学', function(mock) {
      return mock.config('title');
    }, "Set a Greek `title`, object syntax, returns `undefined`", void 0, function(mock) {
      return mock.config({
        title: 'Γλωσσική Εκμὰθηση'
      });
    }, "Check that Greek `title` has been set", 'Γλωσσική Εκμὰθηση', function(mock) {
      return mock.config('title');
    }
  ]);

  tudor.section("Set an invalid config value");

  tudor.is([
    "Returns an array", A, function(mock) {
      return mock.config('title', '');
    }
  ]);

  tudor.equal([
    "The array has one element", 1, function(mock) {
      return (mock.config('title', '')).length;
    }, "The array element is an expected error message", "Key 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function(mock) {
      return (mock.config('title', ''))[0];
    }
  ]);

  tudor.page("`apage.render()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`render()` is a function", F, function(mock) {
      return mock.render;
    }, "Returns a string", S, function(mock) {
      return mock.render();
    }
  ]);

  tudor.equal([
    "Returned string is expected length", 2657, function(mock) {
      return mock.render().length;
    }, "Shorter `title` changes string length", 2645, function(mock) {
      mock.config('title', 'OK');
      return mock.render().length;
    }
  ]);

}).call(this);
