// Generated by CoffeeScript 1.9.2

/*! Apage 0.0.13 //// MIT Licence //// http://apage.richplastow.com/ */

(function() {
  var Article, Main, Tudor, dirname, filename, filterLine, marked, ordername, page, parseFilename, renderer, script, tidypath, tudor, ª, ªA, ªB, ªE, ªF, ªI, ªN, ªO, ªR, ªS, ªU, ªV, ªX, ªclone, ªex, ªhas, ªpopulate, ªtype,
    slice = [].slice,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  ªI = 'Apage';

  ªV = '0.0.13';

  ªA = 'array';

  ªB = 'boolean';

  ªE = 'error';

  ªF = 'function';

  ªN = 'number';

  ªO = 'object';

  ªR = 'regexp';

  ªS = 'string';

  ªU = 'undefined';

  ªX = 'null';

  ª = console.log.bind(console);

  ªex = function(x, a, b) {
    var pos;
    if (-1 === (pos = a.indexOf(x))) {
      return x;
    } else {
      return b.charAt(pos);
    }
  };

  ªhas = function(h, n, t, f) {
    if (t == null) {
      t = true;
    }
    if (f == null) {
      f = false;
    }
    if (-1 !== h.indexOf(n)) {
      return t;
    } else {
      return f;
    }
  };

  ªtype = function(x) {
    return {}.toString.call(x).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
  };

  ªpopulate = function(candidate, subject, rules, updating) {
    var errors, j, k, key, len, len1, rule, test, type, use, value;
    if (ªO !== ªtype(candidate)) {
      return ["`candidate` is type '" + (ªtype(candidate)) + "' not 'object'"];
    }
    errors = [];
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (updating || void 0 !== use) {
          continue;
        } else {
          errors.push("Missing field '" + key + "' is mandatory");
        }
      } else if (type !== ªtype(value)) {
        errors.push("Field '" + key + "' is type '" + (ªtype(value)) + "' not '" + type + "'");
      } else if (!test.test(value)) {
        errors.push("Field '" + key + "' fails " + ('' + test));
      }
    }
    if (errors.length) {
      return errors;
    }
    for (k = 0, len1 = rules.length; k < len1; k++) {
      rule = rules[k];
      key = rule[0], use = rule[1], type = rule[2], test = rule[3];
      value = candidate[key];
      if (void 0 === value) {
        if (void 0 === subject[key]) {
          subject[key] = use;
        }
      } else {
        subject[key] = value;
      }
    }
  };

  ªclone = function(subject, rules) {
    var j, key, len, out, rule;
    out = {};
    for (j = 0, len = rules.length; j < len; j++) {
      rule = rules[j];
      key = rule[0];
      out[key] = subject[key];
    }
    return out;
  };

  parseFilename = function(nm, part) {
    var dash, dot, parts;
    if (ªS !== ªtype(nm)) {
      throw new Error("`nm` is " + (ªtype(nm)) + ", not string");
    }
    parts = {};
    dash = nm.indexOf('-');
    dot = nm.indexOf('.');
    if (-1 === dot) {
      nm += '.';
      dot = nm.length - 1;
    }
    if (-1 !== dash && dash < dot) {
      parts.order = nm.substr(0, dash) * 1;
      if (isNaN(parts.order)) {
        dash = -1;
      }
    } else {
      dash = -1;
    }
    parts.title = nm.substr(dash + 1, dot - dash - 1);
    parts.ext = nm.substr(dot + 1);
    parts.slug = parts.title.toLowerCase().replace(/[“”‘’,]/g, '').replace(/[\s–—…·:;]/g, '-').replace(/^-+|-+$/g, '').replace(/-+/g, '-').replace(/[àáäâèéëêìíïîòóöôùúüûñç]/g, function(c) {
      return ªex(c, 'àáäâèéëêìíïîòóöôùúüûñç', 'aaaaeeeeiiiioooouuuunc');
    });
    if (isNaN(parts.order)) {
      parts.order = parts.slug * 1;
    }
    if (isNaN(parts.order)) {
      parts.order = parts.slug;
    }
    if (!part) {
      return parts;
    }
    if (ªU !== ªtype(parts[part])) {
      return parts[part];
    }
    throw new Error("`part` not recognised, use 'order|title|slug|ext'");
  };

  Article = (function() {
    Article.prototype.I = 'Article';

    Article.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Article.prototype._rules = {
      config: [['path', void 0, 'string', /^[a-z0-9][-\/a-z0-9]{0,63}\.[.a-z0-9]+$/i], ['raw', '', 'string', /^[^\x00-\x08\x0E-\x1F]{0,10000}$/]]
    };

    function Article(config) {
      var errors, fname, i, j, key, len, line, ref, ref1, value;
      if (config == null) {
        config = {};
      }
      this._config = {};
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
      this.path = this._config.path.replace(/^[.\/]+|[.\/]+$/g, '');
      this.id = (function() {
        var j, len, ref, results;
        ref = this.path.split('/');
        results = [];
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          fname = ref[i];
          results.push(parseFilename(fname, 'slug'));
        }
        return results;
      }).call(this);
      this.id = 'apage_' + this.id.join('_');
      this.order = parseFilename(fname, 'order');
      this.front = [];
      if ('---\n' === this._config.raw.substr(0, 4)) {
        this._config.raw = this._config.raw.split('---\n');
        ref = this._config.raw[1].split('\n');
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          line = ref[i];
          ref1 = line.split(':'), key = ref1[0], value = 2 <= ref1.length ? slice.call(ref1, 1) : [];
          key = key != null ? key.replace(/^\s+|\s+$/g, '') : void 0;
          value = value != null ? value.join(':').replace(/^\s+|\s+$/g, '') : void 0;
          if (!key || !value) {
            continue;
          }
          switch (key) {
            case 'id':
              this.id = "apage_" + (value.replace(/^apage_/, ''));
              break;
            case 'order':
              this.order = isNaN(value * 1) ? value : parseInt(value, 10);
              break;
            case 'title':
              this.title = value;
              break;
            default:
              this.front.push([key, value]);
          }
        }
        this._config.raw = (this._config.raw.slice(2)).join('---\n');
      }
      this._config.raw = this._config.raw.replace(/^\s+|\s+$/g, '');
      this.title = this.title || (this._config.raw.split('\n'))[0];
      this.html = (marked(this._config.raw)).replace(/\\/g, '\\\\').split('\n');
    }

    Article.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    return Article;

  })();

  Main = (function() {
    Main.prototype.I = ªI;

    Main.prototype.V = ªV;

    Main.prototype.toString = function() {
      return "[object " + this.I + "]";
    };

    Main.prototype._rules = {
      config: [['title', 'Untitled', 'string', /^[^\x00-\x1F]{1,24}$/], ['url', false, 'string', /^[-:.\/a-z0-9]{1,64}$/], ['plugin', '', 'string', /^[^\x00-\x08\x0E-\x1F]{0,10000}$/]]
    };

    function Main(config) {
      var errors;
      if (config == null) {
        config = {};
      }
      this._config = {};
      this._articles = [];
      if (errors = ªpopulate(config, this._config, this._rules.config)) {
        throw new Error('Invalid `config`:\n  ' + errors.join('\n  '));
      }
    }

    Main.prototype.config = function(key, value) {
      var obj;
      switch (arguments.length) {
        case 0:
          return ªclone(this._config, this._rules.config);
        case 1:
          switch (ªtype(key)) {
            case ªS:
              return this._config[key];
            case ªO:
              return ªpopulate(key, this._config, this._rules.config, true);
          }
          break;
        case 2:
          obj = {};
          obj[key] = value;
          return this.config(obj);
      }
    };

    Main.prototype.browse = function() {
      var a, j, len, ref, results;
      ref = this._articles;
      results = [];
      for (j = 0, len = ref.length; j < len; j++) {
        a = ref[j];
        results.push((function(a) {
          return {
            id: a.id,
            order: a.order
          };
        })(a));
      }
      return results;
    };

    Main.prototype.add = function(article) {
      var instance;
      if (!article) {
        return this;
      }
      instance = new Article(article);
      if (this._articles[instance.id]) {
        throw new Error("'" + instance.id + "' already exists");
      }
      this._articles.push(instance);
      this._articles.sort(function(a, b) {
        if (a.order > b.order) {
          return 1;
        }
        if (a.order < b.order) {
          return -1;
        }
        if (a.id > b.id) {
          return 1;
        }
        if (a.id < b.id) {
          return -1;
        }
        return 0;
      });
      this._articles[instance.id] = instance;
      return this;
    };

    Main.prototype.render = function() {
      return "" + (page(this._config, this._articles));
    };

    return Main;

  })();

  if (ªF === typeof define && define.amd) {
    define(function() {
      return Main;
    });
  } else if (ªO === typeof module && module && module.exports) {
    module.exports = Main;
  } else {
    this[ªI] = Main;
  }

  if (ªF === typeof define && define.amd) {

  } else if (ªO === typeof module && module && module.exports) {
    marked = require('marked');
  } else {
    marked = window.marked;
  }

  renderer = new marked.Renderer;

  renderer.heading = function(text, level) {
    return "<h" + level + ">" + text + "</h" + level + ">\n";
  };

  marked.setOptions({
    renderer: renderer
  });

  page = function(config, articles) {
    var article, comment, generator, i, j, k, len, len1, line, out, ref;
    generator = ªI + " " + ªV + " http://apage.richplastow.com/";
    comment = config.plugin ? '‘Inspect Element’ here, for Apage’s injected CSS' : 'Apage was configured with no plugins, so no CSS is injected here';
    out = ["<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title>" + config.title + "</title>\n  <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\">\n  <meta name=\"generator\" content=\"" + generator + "\">\n  <style>\n    /* " + comment + " */\n  </style>\n" + (script(config, articles)) + "\n</head>\n<body>\n"];
    if (!articles.length) {
      out.push('<!-- Apage was rendered with no articles -->\n');
    }
    for (i = j = 0, len = articles.length; j < len; i = ++j) {
      article = articles[i];
      out.push("<article id=\"" + article.id + "\"\n        class=\"apage\"\n  data-apage-opath=\"/" + article.path + "\"\n  data-apage-dname=\"_" + (dirname(article.path)) + "\"\n  data-apage-order=\"" + article.order + "\"\n  data-apage-front='" + ((JSON.stringify(article.front)).replace(/'/g, "&#39;")) + "'\n  data-apage-title=\"" + article.title + "\">");
      ref = article.html;
      for (k = 0, len1 = ref.length; k < len1; k++) {
        line = ref[k];
        out.push(filterLine(config, line));
      }
      out.push("</article><!-- / #" + article.id + " -->\n\n");
    }
    comment = config.plugin ? '‘Inspect Element’ here, for Apage’s injected elements' : 'Apage was configured with no plugins, so nothing is injected here';
    out.push("<!-- " + comment + " -->");
    return out.join('\n  ') + '\n\n</body>\n</html>';
  };

  filterLine = function(config, line) {
    var rx;
    if (config.url) {
      rx = new RegExp('href="' + config.url, 'g');
      return line.replace(rx, 'href="');
    } else {
      return line;
    }
  };

  tidypath = function(p) {
    var name, order;
    name = filename(p).split('-');
    order = name[0];
    name = isNaN(order * 1) ? name.join('-') : name.slice(1).join('-');
    return dirname(p) + name.split('.').slice(0, -1).join('.');
  };

  dirname = function(p) {
    return ªhas(p, '/', p.split('/').slice(0, -1).join('_') + '_', '');
  };

  filename = function(p) {
    return p.split('/').slice(-1)[0];
  };

  ordername = function(p) {
    var order;
    order = filename(p).split('-')[0];
    if (isNaN(order * 1)) {
      return '';
    } else {
      return order * 1;
    }
  };

  script = function(config, articles) {
    if (!config.plugin) {
      return '';
    }
    return "\n  <script>\n\n//// When the DOM is ready, set up Apage and inject the plugins. \nwindow.addEventListener('load', function () { (function (d) { 'use strict'; \n\n\n//// Declare iterator, length and HTML-reference variables. \nvar i, l, $ref\n\n\n//// Initialize two arrays which are available to all Apage plugins. \n ,arts      = []\n ,resolvers = []\n ,updaters  = []\n\n\n//// Like jQuery, but native. \n ,$  = d.querySelector.bind(d)\n ,$$ = d.querySelectorAll.bind(d)\n\n\n//// Get a reference to all `<article class=\"apage\">` elements. \n ,$arts = $$('article.apage')\n\n\n//// Convert JavaScript’s native `arguments` object to an array. \n ,getArgs = function (args, offset) {\n    return Array.prototype.slice.call(args, offset || 0);\n }\n\n\n//// `unattribute($ref,'data-apage-','opath'...)` removes data attributes. \n ,unattribute = function ($ref, prefix) {\n    for ( var i=0, suffs=getArgs(arguments,2), l=suffs.length; i<l; i++ ) {\n      $ref.removeAttribute(prefix + suffs[i]);\n    }\n  }\n\n\n//// Runs each resolver in order. These are added by the plugins, below. \n//// Resolvers are used to map a query to an article. \n ,resolve = function (query) {\n    for (var i=0, l=resolvers.length, backstop, result={}; i<l; i++) {\n      result = resolvers[i](query);\n      if (result.art) { break; } // `query` does resolve to an article\n      backstop = result.backstop || backstop; // may return a backstop\n    }\n    return result.art ? result.art : backstop; //@todo test logic of 'last valid backstop return' with several plugins at once\n  }\n\n\n//// Runs each updater in order. These are added by the plugins, below. \n//// Updaters change the current DOM state, eg to show a single article. \n ,update = function (query) {\n    for (var i=0, l=updaters.length, current=resolve(query); i<l; i++) {\n      updaters[i](current);\n    }\n  }\n\n\n//// Tidies the URL hash and runs `update()` when the URL hash changes. \n ,onHashchange = function (event) {\n    update( window.location.hash.substr(1).replace(/\\//g,'_') );\n    if (event) { event.preventDefault(); }\n  }\n\n;\n\n\n//// Populate the `arts` array using data from Apage `<ARTICLE>` elements. \nfor (i=0, l=$arts.length; i<l; i++) {\n  $ref = $arts[i];\n  arts.push({\n    id:    $ref.getAttribute('id')\n   ,opath: $ref.getAttribute('data-apage-opath')\n   ,dname: $ref.getAttribute('data-apage-dname')\n   ,order: $ref.getAttribute('data-apage-order')\n   ,front: JSON.parse( $ref.getAttribute('data-apage-front') )\n   ,title: $ref.getAttribute('data-apage-title')\n   ,$ref:  $ref\n  });\n  unattribute($ref,'data-apage-','opath','dname','order','front','title');\n}\n\n\n//// Begin injecting plugins. \n\n" + config.plugin + "\n\n//// End injecting plugins. \n\n\n//// Run each updater when the page loads, and when the URL hash changes. \nonHashchange();\nwindow.addEventListener('hashchange', onHashchange);\n\n\n}).call(this, document) });\n\n  </script>\n";
  };

  Tudor = (function() {
    Tudor.prototype.I = 'Tudor';

    Tudor.prototype.toString = function() {
      return "[object " + I + "]";
    };

    Tudor.prototype.jobs = [];

    function Tudor(opt) {
      this.opt = opt != null ? opt : {};
      this["do"] = bind(this["do"], this);
      switch (this.opt.format) {
        case 'html':
          this.header = function(summary) {
            return "<style>\n   b.pass   { color: #393 }\n   b.fail   { color: #933 }\n   div      { padding: .5em; }\n   div.fn   { background-color: #ccc }\n   div.pass { background-color: #cfc }\n   div.fail { background-color: #fcc }\n</style>\n<a href=\"#end\" id=\"top\">\u2b07</a>  " + summary;
          };
          this.footer = function(summary) {
            return "\n<a href=\"#top\" id=\"end\">\u2b06</a>  " + summary + "\n<script>\n  document.title='" + (summary.replace(/<\/?[^>]+>/g, '')) + "';\n</script>";
          };
          this.tick = '<b class="pass">\u2713</b>';
          this.cross = '<b class="fail">\u2718</b>';
          break;
        default:
          this.header = function(summary) {
            return "\u2b07  " + summary;
          };
          this.footer = function(summary) {
            return "\n\u2b06  " + summary;
          };
          this.tick = '\u2713';
          this.cross = '\u2718';
      }
    }

    Tudor.prototype["do"] = function() {
      var actual, e, error, expect, failed, j, job, len, md, mock, name, passed, ref, result, runner, summary;
      md = [];
      passed = failed = 0;
      mock = null;
      ref = this.jobs;
      for (j = 0, len = ref.length; j < len; j++) {
        job = ref[j];
        switch (ªtype(job)) {
          case ªF:
            try {
              mock = job(mock);
            } catch (_error) {
              e = _error;
              error = e.message;
            }
            if (error) {
              md.push(this.formatMockModifierError(job, error));
            }
            break;
          case ªS:
            md.push(this.sanitize(job));
            break;
          case ªA:
            runner = job[0], name = job[1], expect = job[2], actual = job[3];
            result = runner(expect, actual, mock);
            if (!result) {
              md.push(this.tick + " " + (this.sanitize(name)) + "  ");
              passed++;
            } else {
              md.push(this.cross + " " + (this.sanitize(name)) + "  ");
              md.push(result);
              failed++;
            }
        }
        summary = failed ? "FAILED " + failed + "/" + (passed + failed) + " " + this.cross : "Passed " + passed + "/" + (passed + failed) + " " + this.tick;
      }
      md.unshift(this.header(summary));
      md.push(this.footer(summary));
      return md.join('\n');
    };

    Tudor.prototype.page = function(text) {
      return this.jobs.push(("\n\n" + text + "\n=") + (new Array(text.length).join('=')));
    };

    Tudor.prototype.section = function(text) {
      return this.jobs.push(("\n\n" + text + "\n-") + (new Array(text.length).join('-')) + '\n');
    };

    Tudor.prototype.formatFail = function(result, delivery, expect, types) {
      if (types) {
        result = result + " (" + (ªtype(result)) + ")";
        expect = expect + " (" + (ªtype(expect)) + ")";
      }
      switch (this.opt.format) {
        case 'html':
          return "<div class=\"fail\">" + (this.sanitize(this.reveal(result))) + "</div>\n...was " + delivery + ", but expected...\n<div class=\"pass\">" + (this.sanitize(this.reveal(expect))) + "</div>";
        default:
          return (this.sanitize(this.reveal(result))) + "\n...was " + delivery + ", but expected...\n" + (this.sanitize(this.reveal(expect)));
      }
    };

    Tudor.prototype.formatException = function(intro, error) {
      switch (this.opt.format) {
        case 'html':
          return intro + "\n<div class=\"fail\">" + (this.sanitize(error.message)) + "</div>";
        default:
          return intro + "\n" + (this.sanitize(error.message));
      }
    };

    Tudor.prototype.formatMockModifierError = function(fn, error) {
      switch (this.opt.format) {
        case 'html':
          return "<div class=\"fn\">" + (this.sanitize(fn + '')) + "</div>\n...encountered an exception:\n<div class=\"fail\">" + (this.sanitize(error)) + "</div>";
        default:
          return (this.sanitize(fn + '')) + "\n...encountered an exception:\n" + (this.sanitize(error));
      }
    };

    Tudor.prototype.reveal = function(value) {
      return value != null ? value.toString().replace(/^\s+|\s+$/g, function(match) {
        return '\u00b7' + (new Array(match.length)).join('\u00b7');
      }) : void 0;
    };

    Tudor.prototype.sanitize = function(value) {
      switch (this.opt.format) {
        case 'html':
          return value != null ? value.toString().replace(/</g, '&lt;') : void 0;
        default:
          return value;
      }
    };

    Tudor.prototype.custom = function(al, runner) {
      var i;
      i = 0;
      while (i < al.length) {
        if (ªF === ªtype(al[i])) {
          this.jobs.push(al[i]);
        } else {
          this.jobs.push([runner, al[i], al[++i], al[++i]]);
        }
        i++;
      }
      return this.jobs.push('- - -');
    };

    Tudor.prototype.throws = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, mock) {
          var e, error;
          error = false;
          try {
            actual(mock);
          } catch (_error) {
            e = _error;
            error = e;
          }
          if (!error) {
            return _this.formatException('No exception thrown, expected', expect);
          } else if (expect !== error.message) {
            return _this.formatFail(error.message, 'thrown', expect);
          }
        };
      })(this));
    };

    Tudor.prototype.equal = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, mock) {
          var e, error, result;
          error = false;
          try {
            result = actual(mock);
          } catch (_error) {
            e = _error;
            error = e;
          }
          if (error) {
            return _this.formatException('Unexpected exception', error);
          } else if (expect !== result) {
            return _this.formatFail(result, 'returned', expect, result + '' === expect + '');
          }
        };
      })(this));
    };

    Tudor.prototype.is = function(al) {
      return this.custom(al, (function(_this) {
        return function(expect, actual, mock) {
          var e, error, result;
          error = false;
          try {
            result = actual(mock);
          } catch (_error) {
            e = _error;
            error = e;
          }
          if (error) {
            return _this.formatException('Unexpected exception', error);
          } else if (expect !== ªtype(result)) {
            return _this.formatFail("type " + (ªtype(result)), 'returned', "type " + expect);
          }
        };
      })(this));
    };

    return Tudor;

  })();

  tudor = new Tudor({
    format: ªO === typeof window ? 'html' : 'plain'
  });

  Main.runTest = tudor["do"];

  tudor.page("01 Main Constructor Usage");

  tudor.section("No `config` Argument");

  tudor.is([
    "Class is a function", ªF, function() {
      return Main;
    }, function() {
      return new Main;
    }, "Instance is an object", ªO, function(mock) {
      return mock;
    }
  ]);

  tudor.equal([
    "`toString()` is '[object Apage]'", '[object Apage]', function(mock) {
      return '' + mock;
    }, "`config` is null", '[object Apage]', function() {
      return '' + new Main(null);
    }
  ]);

  tudor.section("Basic `config`");

  tudor.equal([
    "Set the title", '[object Apage]', function() {
      return '' + new Main({
        title: 'Café'
      });
    }
  ]);

  tudor.page("02 `Apage` Constructor Errors");

  tudor.section("Invalid `config` Argument");

  tudor.throws([
    "`config` is not an object", "Invalid `config`:\n  `candidate` is type 'number' not 'object'", function() {
      return new Main(1);
    }, "`config` is a `Date` object", "Invalid `config`:\n  `candidate` is type 'date' not 'object'", function() {
      return new Main(new Date);
    }, "`config` is a `String` object", "Invalid `config`:\n  `candidate` is type 'string' not 'object'", function() {
      return new Main(new String('yikes!'));
    }
  ]);

  tudor.section("Invalid `config.title`");

  tudor.throws([
    "A number", "Invalid `config`:\n  Field 'title' is type 'number' not 'string'", function() {
      return new Main({
        title: 0
      });
    }, "An empty string", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: ''
      });
    }, "25 characters long", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: '1234567890123456789012345'
      });
    }, "Contains a tab", "Invalid `config`:\n  Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function() {
      return new Main({
        title: 'tab character: \t'
      });
    }
  ]);

  tudor.page("03 `apage.config()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`config()` is a function", ªF, function(mock) {
      return mock.config;
    }, "Returns an object", ªO, function(mock) {
      return mock.config();
    }
  ]);

  tudor.equal([
    "Returned object contains expected defaults", '{"title":"Untitled","url":false,"plugin":""}', function(mock) {
      return JSON.stringify(mock.config());
    }, "Returns a new object each time", false, function(mock) {
      return mock.config() === mock.config();
    }
  ]);

  tudor.section("Retrieve a config value");

  tudor.equal([
    "Default `title` is 'Untitled'", 'Untitled', function(mock) {
      return mock.config('title');
    }, function() {
      return new Main({
        title: '外国語の学習と教授'
      });
    }, "After constructing with Japanese `title`", '外国語の学習と教授', function(mock) {
      return mock.config('title');
    }, "Key not recognized", void 0, function(mock) {
      return mock.config('unrecognized');
    }
  ]);

  tudor.section("Set a valid config value");

  tudor.equal([
    "Set a Chinese `title`, two arg syntax, returns `undefined`", void 0, function(mock) {
      return mock.config('title', '語文教學・语文教学');
    }, "Check that Chinese `title` has been set", '語文教學・语文教学', function(mock) {
      return mock.config('title');
    }, "Set a Greek `title`, object syntax, returns `undefined`", void 0, function(mock) {
      return mock.config({
        title: 'Γλωσσική Εκμὰθηση'
      });
    }, "Check that Greek `title` has been set", 'Γλωσσική Εκμὰθηση', function(mock) {
      return mock.config('title');
    }
  ]);

  tudor.section("Set an invalid config value");

  tudor.is([
    "Returns an array", ªA, function(mock) {
      return mock.config('title', '');
    }
  ]);

  tudor.equal([
    "The array has one element", 1, function(mock) {
      return (mock.config('title', '')).length;
    }, "The array element is an expected error message", "Field 'title' fails /^[^\\x00-\\x1F]{1,24}$/", function(mock) {
      return (mock.config('title', ''))[0];
    }
  ]);

  tudor.page("05 `apage.render()` Usage");

  tudor.section("No argument");

  tudor.is([
    function() {
      return new Main;
    }, "`render()` is a function", ªF, function(mock) {
      return mock.render;
    }, "Returns a string", ªS, function(mock) {
      return mock.render();
    }
  ]);

  tudor.equal([
    "Returned string is expected length", 468, function(mock) {
      return mock.render().length;
    }, "Characters up to opening <title> as expected", "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <title>", function(mock) {
      return mock.render().substr(0, 49);
    }, "Default <title> is 'Untitled'", 'Untitled', function(mock) {
      return mock.render().substr(49, 8);
    }, "Characters from </title> to </html> as expected", "</title>\n  <meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\">\n  <meta name=\"generator\" content=\"Apage 0.0.13 http://apage.richplastow.com/\">\n  <style>\n    /* Apage was configured with no plugins, so no CSS is injected here */\n  </style>\n\n</head>\n<body>\n\n  <!-- Apage was rendered with no articles -->\n\n  <!-- Apage was configured with no plugins, so nothing is injected here -->\n\n</body>\n</html>", function(mock) {
      return mock.render().substr(57);
    }, "Shorter `title` changes string length", 462, function(mock) {
      mock.config('title', 'OK');
      return mock.render().length;
    }
  ]);

  tudor.page("07 `apage.add()` and `apage.browse()` Typical Usage");

  tudor.section("Basic checks and usage, with zero articles");

  tudor.is([
    function() {
      return new Main;
    }, "`add()` is a function", ªF, function(mock) {
      return mock.add;
    }, "`add()` returns an object", ªO, function(mock) {
      return mock.add();
    }, "`browse()` is a function", ªF, function(mock) {
      return mock.browse;
    }, "`browse()` returns an array", ªA, function(mock) {
      return mock.browse();
    }, "Returned `browse()` array is not a shared reference", ªU, function(mock) {
      var a;
      a = mock.browse();
      a.foo = 1;
      return mock.browse().foo;
    }
  ]);

  tudor.equal([
    "Returned `add()` object is the instance itself", true, function(mock) {
      return mock.add() === mock;
    }, "Returned `browse()` array is initially empty", 0, function(mock) {
      return mock.browse().length;
    }
  ]);

  tudor.section("Appending some articles");

  tudor.equal([
    "A very minimal article with numeric name", "<article id=\"apage_123\"\n        class=\"apage\"\n  data-apage-opath=\"/123.md\"\n  data-apage-dname=\"_\"\n  data-apage-order=\"123\"\n  data-apage-front='[]'\n  data-apage-title=\"\">\n  \n  </article><!-- / #apage_123 -->", function(mock) {
      return mock.add({
        path: '123.md'
      }).render().substr(329, 206);
    }, "`browse().length` after adding one article", 1, function(mock) {
      return mock.browse().length;
    }, "Use `browse()` to get article ‘apage_123’s id", 'apage_123', function(mock) {
      return mock.browse()[0].id;
    }, "Use `browse()` to get article ‘apage_123’s order", 123, function(mock) {
      return mock.browse()[0].order;
    }, "A `browse()` element is not a shared reference", void 0, function(mock) {
      var o;
      o = mock.browse()[0];
      o.foo = 1;
      return mock.browse()[0].foo;
    }, "A fairly minimal article with an ordered name", "<article id=\"apage_a_b\"\n        class=\"apage\"\n  data-apage-opath=\"/A/5-b.c.MaRkDoWn\"\n  data-apage-dname=\"_A_\"\n  data-apage-order=\"5\"\n  data-apage-front='[[\"foo\",\"bar\"]]'\n  data-apage-title=\"Ok\">\n  <h1>Ok</h1>\n  <p>Lorem.</p>\n  \n  </article><!-- / #apage_a_b -->", function(mock) {
      return mock.add({
        path: 'A/5-b.c.MaRkDoWn',
        raw: '---\nfoo:bar\n---\nOk\n==\nLorem.'
      }).render().substr(329, 261);
    }, "Use `browse()` to get article ‘apage_a_b’s id", 'apage_a_b', function(mock) {
      return mock.browse()[0].id;
    }, "Use `browse()` to get article ‘apage_a_b’s order", 5, function(mock) {
      return mock.browse()[0].order;
    }, "An article which uses frontmatter to override defaults", "<article id=\"apage_foo\"\n        class=\"apage\"\n  data-apage-opath=\"/7-foo.txt\"\n  data-apage-dname=\"_\"\n  data-apage-order=\"2\"\n  data-apage-front='[[\"My  Custom\",\"Field  : Here\"]]'\n  data-apage-title=\"Foo\">\n  <p>Not the title</p>\n  \n  </article><!-- / #apage_foo -->", function(mock) {
      return mock.add({
        path: '7-foo.txt',
        raw: "---\n  id : apage_foo \n   title:Foo   \norder:02.2\n     My  Custom  :  Field  : Here   \n---\nNot the title"
      }).render().substr(329, 263);
    }, "Use `browse()` to get article ‘apage_foo’s id", 'apage_foo', function(mock) {
      return mock.browse()[0].id;
    }, "Use `browse()` to get article ‘apage_foo’s order", 2, function(mock) {
      return mock.browse()[0].order;
    }, "`browse()` orders after adding three articles", '2 5 123 undefined', function(mock) {
      var browse;
      browse = mock.browse();
      return browse[0].order + " " + browse[1].order + " " + browse[2].order + " " + browse[3];
    }, "Ordering falls back to `id`, when `order` is duplicate", "\"id\": \"apage_2\",\n\"order\": 2\n\"id\": \"apage_e\",\n\"order\": 2\n\"id\": \"apage_foo\",\n\"order\": 2\n\"id\": \"apage_g\",\n\"order\": 2\n\"id\": \"apage_h\",\n\"order\": 2\n\"id\": \"apage_a_b\",\n\"order\": 5\n\"id\": \"apage_123\",\n\"order\": 123", function(mock) {
      return JSON.stringify(mock.add({
        path: '2-h.md'
      }).add({
        path: '2-e.md'
      }).add({
        path: '2.md'
      }).add({
        path: '2-G.md'
      }).browse(), null, 2).replace(/\s \},\n  \{\n|    /g, '').slice(6, -6);
    }
  ]);

  tudor.page("10 `apage.add()` Errors");

  tudor.section("Invalid `article` argument");

  tudor.throws([
    function() {
      return new Main;
    }, "`config` is a number", "Invalid `config`:\n  `candidate` is type 'number' not 'object'", function(mock) {
      return mock.add(456);
    }
  ]);

  tudor.equal([
    "Invalid object is not added", 0, function(mock) {
      return mock.browse().length;
    }
  ]);

  tudor.section("Invalid `path` field");

  tudor.throws([
    "`path` is not set", "Invalid `config`:\n  Missing field 'path' is mandatory", function(mock) {
      return mock.add({});
    }, "`path` is a boolean", "Invalid `config`:\n  Field 'path' is type 'boolean' not 'string'", function(mock) {
      return mock.add({
        path: true
      });
    }, "`path` is an empty string", "Invalid `config`:\n  Field 'path' fails /^[a-z0-9][-\\/a-z0-9]{0,63}\\.[.a-z0-9]+$/i", function(mock) {
      return mock.add({
        path: ''
      });
    }, "`path` is too long", "Invalid `config`:\n  Field 'path' fails /^[a-z0-9][-\\/a-z0-9]{0,63}\\.[.a-z0-9]+$/i", function(mock) {
      return mock.add({
        path: (new Array(66)).join('-')
      });
    }, "`path` contains a backslash", "Invalid `config`:\n  Field 'path' fails /^[a-z0-9][-\\/a-z0-9]{0,63}\\.[.a-z0-9]+$/i", function(mock) {
      return mock.add({
        path: 'a\\b'
      });
    }, "`path` contains an underscore", "Invalid `config`:\n  Field 'path' fails /^[a-z0-9][-\\/a-z0-9]{0,63}\\.[.a-z0-9]+$/i", function(mock) {
      return mock.add({
        path: 'a_b'
      });
    }, "`path` begins with a hyphen", "Invalid `config`:\n  Field 'path' fails /^[a-z0-9][-\\/a-z0-9]{0,63}\\.[.a-z0-9]+$/i", function(mock) {
      return mock.add({
        path: '-a'
      });
    }, "Duplicate `id`, due to identical `path` slugs", "'apage_a' already exists", function(mock) {
      mock.add({
        path: '00-A.txt'
      });
      return mock.add({
        path: '3-a.jpeg'
      });
    }
  ]);

  tudor.section("Invalid `raw` field");

  tudor.throws([
    "`raw` is an object", "Invalid `config`:\n  Field 'raw' is type 'object' not 'string'", function(mock) {
      return mock.add({
        path: 'a.md',
        raw: {}
      });
    }, "`raw` is too long", "Invalid `config`:\n  Field 'raw' fails /^[^\\x00-\\x08\\x0E-\\x1F]{0,10000}$/", function(mock) {
      return mock.add({
        path: 'b.md',
        raw: (new Array(10002)).join('-')
      });
    }, "`raw` contains an invalid character", "Invalid `config`:\n  Field 'raw' fails /^[^\\x00-\\x08\\x0E-\\x1F]{0,10000}$/", function(mock) {
      return mock.add({
        path: 'b.md',
        raw: 'x\bz'
      });
    }
  ]);

  tudor.equal([
    "Invalid objects still not added", 1, function(mock) {
      return mock.browse().length;
    }
  ]);

  tudor.page("11 App Helpers, Errors and Usage: `parseFilename()`");

  tudor.section("Basic checks and errors");

  tudor.is([
    "`parseFilename()` is a function", ªF, function() {
      return parseFilename;
    }
  ]);

  tudor.throws([
    "Called with no arguments", '`nm` is undefined, not string', function() {
      return parseFilename();
    }, "Called with wrong `fn` type", '`nm` is number, not string', function() {
      return parseFilename(1);
    }, "Called with unrecognised `part` string", "`part` not recognised, use 'order|title|slug|ext'", function() {
      return parseFilename('abc', 123);
    }
  ]);

  tudor.section("Typical 'order' usage");

  tudor.equal([
    "Get the order from a typical filename", 3, function() {
      return parseFilename('03-The Third.txt', 'order');
    }, "Fractional orders are not allowed", 3, function() {
      return parseFilename('3.1-Only whole numbers allowed.txt', 'order');
    }, "The order must only contain digits", '3b-must-all-be-digits', function() {
      return parseFilename('3b-Must all be digits.md.txt', 'order');
    }
  ]);

  tudor.section("Typical 'title' usage");

  tudor.equal([
    "Get the title from a typical filename", 'The Third', function() {
      return parseFilename('03-The Third.txt', 'title');
    }, "Fractional orders are not allowed", '3', function() {
      return parseFilename('3.1-Only whole numbers allowed.txt', 'title');
    }, "The order must only contain digits", '3b-Must all be digits', function() {
      return parseFilename('3b-Must all be digits.md.txt', 'title');
    }
  ]);

  tudor.section("Typical 'slug' usage");

  tudor.equal([
    "Get the slug from a typical filename", 'the-third', function() {
      return parseFilename('03-The Third.txt', 'slug');
    }, "Fractional orders are not allowed", '3', function() {
      return parseFilename('3.1-Only whole numbers allowed.txt', 'slug');
    }, "The order must only contain digits", '3b-must-all-be-digits', function() {
      return parseFilename('3b-Must all be digits.md.txt', 'slug');
    }
  ]);

  tudor.section("Typical 'ext' usage");

  tudor.equal([
    "Get the ext from a typical filename", 'txt', function() {
      return parseFilename('03-The Third.txt', 'ext');
    }, "Fractional orders are not allowed", '1-Only whole numbers allowed.txt', function() {
      return parseFilename('3.1-Only whole numbers allowed.txt', 'ext');
    }, "The order must only contain digits", 'md.txt', function() {
      return parseFilename('3b-Must all be digits.md.txt', 'ext');
    }
  ]);

  tudor.section("Typical usage with no 'part' argument");

  tudor.equal([
    "Get the order from a typical filename", 3, function() {
      return (parseFilename('03-The Third.txt')).order;
    }, "Fractional orders are not allowed", '3', function() {
      return (parseFilename('3.1-Only whole numbers allowed.txt')).slug;
    }, "The order must only contain digits", 'md.txt', function() {
      return (parseFilename('3b-Must all be digits.md.txt')).ext;
    }
  ]);

  tudor.section("Edge case orders");

  tudor.equal([
    "Filename is all digits", 123456, function() {
      return parseFilename('123456.txt', 'order');
    }
  ]);

  tudor.section("Advanced slugification");

  tudor.equal([
    "Leading, trailing, and multiple whitespace is removed", 'spaces-and-tabs-before-and-after', function() {
      return parseFilename(' \t spaces  and tabs   before and after  \t ', 'slug');
    }, "Some punctuation is removed", 'its-too-punctuated', function() {
      return parseFilename('“It’s too, ‘punctuated’”. It’s kept here!', 'slug');
    }, "Some punctuation marks are converted to hyphens", 'em-en-etc', function() {
      return parseFilename('em —, en – … etc.', 'slug');
    }, "Some accents are removed", 'cafe-cafe', function() {
      return parseFilename('CAFÉ, café', 'slug');
    }
  ]);

}).call(this);
